<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生管理系统</title>
</head>

<body>
    <h2>新增学生</h2>
    <div>
        <span>学生姓名：</span><input type="text" id="name" name="name"><br>
        <span>学生年龄：</span><input type="text" id="age" name="age"><br>
        <span>学生性别：</span>男<input type="radio" name="sex" value="男" checked> / 女<input type="radio" name="sex"
            value="女"><br>
        <button id="addStudents">新 增</button>
    </div>

    <h2>查询学生</h2>
    <select id="searchType">
        <option value="all">全部</option>
        <option value="name">姓名</option>
        <option value="age">年龄</option>
        <option value="gender">性别</option>
    </select>
    <input type="text" id="searchValue"><button id="searchBtn">查询</button>

    <h2>修改学生信息</h2>
    <div>
        <input type="hidden" id='updateId'>
        <span>学生姓名：</span><input type="text" id="updatename" name="name"><br>
        <span>学生年龄：</span><input type="text" id="updateage" name="age"><br>
        <span>学生性别：</span>男<input type="radio" name="updatesex" value="男" checked> / 女<input type="radio"
            name="updatesex" value="女"><br>
        <button id="updateStudents">确认修改</button>
    </div>

    <h2>学生列表</h2>
    <table>
        <thead>
            <tr>
                <th>学生姓名</th>
                <th>学生年龄</th>
                <th>学生性别</th>
                <th>学生操作</th>
            </tr>
        </thead>
        <tbody class="tbody">

        </tbody>
    </table>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        let data = {
            searchType: 'name',
            searchValue: ''
        };
        getStudents();
        // 学生列表/部分查询
        function getStudents() {
            $.ajax({
                url: '/students/getStudents',
                type: 'get',
                data: data,
                success({ message, status, data }) {
                    if (status) {
                        // 渲染数据

                        // 方式三：
                        const str = data.map(function (item, index) {
                            return `<tr>
                                    <td>${item.name}</td>
                                    <td>${item.age}</td>
                                    <td>${item.gender}</td>
                                    <td>
                                        <button class="updateBtn" data-id='${item._id}'>修改</button>
                                        <button class="removeBtn" data-id='${item._id}'>删除</button>
                                    </td>
                                </tr>`
                        }).join('')
                        $('tbody').html(str)

                        // 方式二:只需要添加一次
                        // let str = ''
                        // data.forEach(item => {
                        //     str += `<tr>
                        //             <td>${item.name}</td>
                        //             <td>${item.age}</td>
                        //             <td>${item.gender}</td>
                        //             <td>
                        //                 <button>修改</button>
                        //                 <button>删除</button>
                        //             </td>
                        //         </tr>`;
                        // });
                        // $('tbody').append(str)


                        // 方式一
                        // data.forEach(item => {
                        //     $('tbody').append(`
                        //         <tr>
                        //             <td>${item.name}</td>
                        //             <td>${item.age}</td>
                        //             <td>${item.gender}</td>
                        //             <td>
                        //                 <button>修改</button>
                        //                 <button>删除</button>
                        //             </td>
                        //         </tr>
                        //     `)
                        // });
                    }
                }
            })
        }

        // 删除学生信息
        $('.tbody').on('click', '.removeBtn', function (e) {
            // 拿到对应对象的id
            let _id = $(this).data('id');
            $.ajax({
                url: '/students/deleteStudent',
                type: 'post',
                data: { _id },
                success(msg) {
                    if (msg.status) {
                        alert("删除成功！");
                        getStudents();
                    }
                }
            })
        })

        // 新增学生信息
        $('#addStudents').click(function () {
            let name = $('[name=name]').val();
            let age = $('[name=age]').val();
            let gender = $('[name=sex]:checked').val();
            $.ajax({
                url: '/students/addStudents',
                type: 'post',
                data: {
                    name, age, gender
                },
                success(msg) {
                    if (msg.status) {
                        getStudents();
                    }
                }
            })
        })

        // 查询指定学生信息
        $('#searchBtn').click(function () {
            let searchType = $('#searchType').val();
            let searchValue = $('#searchValue').val();
            data = {
                searchType: 'name',
                searchValue: ''
            };
            if (searchType == 'all') {
                getStudents();
            } else {
                // 原始 data[searchType]=searchValue
                // 模糊查询匹配
                data = {
                    searchType,
                    searchValue
                }
                getStudents();
            }
        })

        // 修改学生信息
        // 通过id获取要修改学生的信息
        $('.tbody').on('click', '.updateBtn', function (e) {
            // 拿到对应对象的id
            let _id = $(this).data('id');
            $.ajax({
                url: '/students/getStudentById',
                type: 'get',
                data: { _id },
                success(msg) {
                    if (msg.status) {
                        $('#updatename').val(msg.data.name);
                        $('#updateage').val(msg.data.age);
                        $(`[name=updatesex][value=${msg.data.gender}]`).prop('checked', true);
                        $('#updateId').val(msg.data._id);
                    }
                }
            })
        })
        // 修改学生信息
        $('#updateStudents').click(function () {
            let _id = $('#updateId').val();
            let name = $('#updatename').val();
            let age = $('#updateage').val();
            let gender = $('[name=updatesex]:checked').val();
            $.ajax({
                url: '/students/updateStudents',
                type: 'post',
                data: {
                    _id,
                    name,
                    age,
                    gender
                },
                success(msg) {
                    if (msg.status) {
                        alert('修改该学生信息成功！')
                    }
                    getStudents();
                }
            })
        })
    </script>
</body>

</html>